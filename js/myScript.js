var jsonFullDescription =
    `{"countProducts": 9,
        "products":[
            {
                "id": 0,
                "short_description": "Горные лыжи ATOMIC BENT CHETLER 100 + N WARDEN 11 MNC (21/22) Grey-Green",
                "type": "ski",
                "image": "./images/products/Ski_atomic.jpg",
                "price": 54990,
                "description": "Самый универсальный член семейства Bent Chetler – Atomic Bent Chetler 100 – это поистине модель для фрирайда, которая может всё. Разработанные легендой Крисом Бенчетлером, эти лыжи all-mountain – зауженная версия великолепной авторской модели с умеренно широкой 100-мм талией, реально универсальны. Направленная форма Bent Chetler 100 с уникальной технологией HRZN Tech в носке и пятке для повышения площади опоры и плавучести, Light Woodcore и внушительный рокер Powder для катания повсюду."
            },
            {
                "id": 1,
                "short_description": "Горные лыжи ELAN AMPHIBIO 10Ti PS + EL 10 GW (21/22)",
                "type": "ski",
                "image": "./images/products/Elan.jpg",
                "price": 39590,
                "description": "Amphibio 10 – настоящие универсалы для любых склонов. Инновационная технология Amphibio и продуманная гибкость – эти лыжи готовы ко всему. Их безграничная универсальность гарантирована удостоенным наград профилем Amphibio, сочетающим весовой прогиб и рокер в одной лыже. Это обеспечивает надёжную хватку кантов и лучшую отзывчивость."
            },
            {
                "id": 2,
                "short_description": "Горные лыжи HEAD EPIC JOY + JOY 11 GW SLR BR 78 (21/22) Black-Choppergold",
                "type": "ski",
                "image": "./images/products/Ski_park.jpg",
                "price": 49192,
                "description": "Epic Joy – это не просто сверхлёгкие лыжи, они олицетворяют чистую элегантность. С этими высокопроизводительными лыжами вы можете прогрессировать с каждым днём. Лыжи полностью раскрывают свой потенциал на склонах. Когда темп увеличивается, эти лыжи сохраняют баланс и контроль."
            },
            {
                "id": 3,
                "short_description": "Сноуборд BURTON CUSTOM X FLYING V (21/22)",
                "type": "snowboard",
                "image": "./images/products/Burton_X.jpg",
                "price": 69300,
                "description": "Агрессивный сноуборд Burton с прогибом Flying V — отличный выбор для тех, кто ищет скорость и контроль профессионального уровня. Модель имеет легкий наборный деревянный сердечник, усиленный карбоном. Burton Custom X Flying V это высокая жёсткость и прогиб Flying V, сочетающий достоинства кэмбера и рокера, переменная толщина и жёсткость сердечника по технологии Squeezebox, которая делает модель более стабильной и отзывчивой."
            },
            {
                "id": 4,
                "short_description": "Сноуборд ATOM City Surfer (20/21)",
                "type": "snowboard",
                "image": "./images/products/Atom_City_Surfer.jpg",
                "price": 10362,
                "description": "Новая модель City Surfer от бренда Atom. Это борд с молниеносно быстротой, эффективной гибкостью, отзывчивостью и плавным тотальным контролем. City Surfer обеспечит вам 100% успех на всех горных склонах."
            },
            {
                "id": 5,
                "short_description": "Сноуборд CAPITA SPACE METAL FANTASY (21/22)",
                "type": "snowboard",
                "image": "./images/products/Capit_Space_Metal_Fantasy.jpg",
                "price": 37950,
                "description": "Пятикратный победитель премии Good Wood, сноуборд Space Metal Fantasy от Capita является примером лучшей и крутейшей женской парковой доски! Прощающая форма в виде комбинации рокеров и флэта не ограничивает при этом райдера только лишь фристайловыми скиллами ;)"
            },
            {
                "id": 6,
                "short_description": "Велосипед HORH BUBBLE BL HD 26 (2021) Black-Blue *",
                "type": "bicycle",
                "image":"./images/products/bicycle_Horh_Bubble.jpg",
                "price": 32807,
                "description": "Обновлённый фэтбайк Horh Bubble на надёжных дисковых гидравлических тормозах! Его широченные 26x4,0d колёса позволят уверенно чувствовать себя даже на песке и снегу, не говоря уже о таких препятствиях как кочки, бордюры и прочие неприятные неровности дороги."
            },
            {
                "id": 7,
                "short_description": "Велосипед HORH FOREST FHD 7.1 27.5 (2021) Grey-Orange",
                "type": "bicycle",
                "image": "./images/products/bicycle_Horh_Forest.jpg",
                "price": 23291,
                "description": "Стильный Horh Forest 7.1 станет отличным решением для райдера, который хочет увидеть себя на мощном горном байке. Этот велосипед – идеальное сочетание выгодной цены и европейского качества вкупе с оборудованием Shimano класса Tourney, амортизационной вилкой с ходом в 100 мм и трансмиссией на 24 скорости."
            },
            {
                "id": 8,
                "short_description": "Велосипед WELT Peak 24 (2021) Dark Grey",
                "type": "bicycle",
                "image": "./images/products/Welt_Peak.jpg",
                "price": 26990,
                "description": "Welt Peak 24 – подростковый горный велосипед на 24d колёсах, подойдёт для катания по лёгкому бездорожью, в парках и городе. Лёгкая рама состоит из труб, со специально разработанной для подростковых велосипедов формой. Нижняя труба сложного сечения и усилительный элемент у рулевого стакана придают дополнительную надёжность в любых условиях эксплуатации. Продуманная геометрия позволяет легко преодолевать препятствия в условиях бездорожья и чувствовать себя комфортно при катании в городской черте."
            }
        ]
    }`;

let products = JSON.parse(jsonFullDescription); // Данные из json'a
let baseSort = [];
let sortType = "";
let mySmsPassword = "123123";
let enter = false;
let countProductsLoad = products.countProducts
// Заполняем список ключами json'a(id);
for (i = 0; i < countProductsLoad; i++){
    baseSort.push(i);
}
let products_load = []; // Хранения готовых блоков с продуктами.

menu.onclick = function menuListener(){
    var x = document.getElementById("menubar");

    if (x.className == "responsible"){
        x.className = "menubar";
    } else {
        x.className = "responsible";
    }
}

// Добавляем обработку нажатий на кнопки
document.querySelectorAll(".dropdown").forEach(el => {
    el.addEventListener("click", function (){
        sortProducts(sortType, el.textContent);
        // getInfoFromUrl()
    })
    }
);

registration.onclick = function regListener(){

    if (!enter){

        // Удаление прошлых элемнтов.
        while (document.querySelector('.main').firstChild) {
            document.querySelector('.main').removeChild(document.querySelector('.main').firstChild);
        }

        // Замена заголовков страницы
        if (document.getElementById("catalogTitle") != null){
            document.getElementById("catalogTitle").remove();
        }

        // Если надпись еще не была добавлена.
        if (document.getElementById("autorizationTitle") == null){
            let newTitle = document.createElement('p');
            newTitle.id = "autorizationTitle";
            newTitle.textContent = '/Авторизация';
            newTitle.className = "adder_title-page";
            document.getElementById("myTitle").appendChild(newTitle);
        }

        document.getElementById('myTypePage').textContent = "Авторизация и регистрация"

        // Заполнение окна регистрации
        let section = document.createElement('section');
        section.className = "authorization";
        document.querySelector(".main").appendChild(section);

        // Создаем форму(у нас случай учебный, поэтому создам div)
        let formReg = document.createElement("div");
        formReg.className = "authorization__form"
        section.appendChild(formReg);
        // теперь заполним его полями.
        let authorizationTitle = document.createElement("h2");
        authorizationTitle.className = "authorization__title";
        authorizationTitle.textContent = "Вход или регистрация";
        formReg.appendChild(authorizationTitle);

        let authorizationLabel = document.createElement("div");
        authorizationLabel.className = "authorization__label";
        authorizationLabel.textContent = "Номер телефона*";
        formReg.appendChild(authorizationLabel);

        let authorizationSub = document.createElement("div");
        authorizationSub.className = "authorization__sub";
        authorizationSub.textContent = "На ваш номер будет отправлено СМС-сообщение c кодом подтверждения";
        formReg.appendChild(authorizationSub);

        let authorizationFieldWrapper = document.createElement("div");
        authorizationFieldWrapper.className = "authorization__field-wrapper";
        formReg.appendChild(authorizationFieldWrapper);
        let field_error = document.createElement("div");
        field_error.className = "field_error";
        let spanError = document.createElement("span");
        spanError.className = "span_error";
        spanError.textContent = "Некоректные данные";
        formReg.appendChild(field_error);

        // Добавляем поле ввода номера телефона.
        let input = document.createElement("input");
        input.className = "input_style";
        input.placeholder = "+79180002277";
        input.value = "+7";
        input.name = "phone";
        input.type = "tel";
        input.maxLength = 12;
        input.pattern="[+]7\s[\(]\d{3}[\)]\s\d{3}[\-]\d{2}[\-]\d{2}";
        input.title="Используйте формат: +7 (777) 777-77-77";
        input.addEventListener('keyup', function(){
            this.value = this.value.replace(/[^\+^\d]/g, '');
        });
        formReg.appendChild(input);

        let authorizationSend = document.createElement("button");
        authorizationSend.textContent = "Отправить смс";
        authorizationSend.className = "authorization__send";

        authorizationSend.onclick = function sendListener(){
            if (input.value.length == 12 && input.value.slice(0,2) == "+7"){
                // Здесь сделать кнопку.
                if (document.querySelector(".span_error") != null){
                    document.querySelector(".span_error").remove();
                }
                let inputSms = document.createElement("input");
                inputSms.className = "input_style";
                inputSms.name = "sms";
                inputSms.type = "password";
                inputSms.maxLength = 6;
                inputSms.placeholder = "Введите код смс";
                inputSms.addEventListener('keyup', function(){
                    this.value = this.value.replace(/[^\+^\d]/g, '');
                });

                document.querySelector(".authorization__send").remove();
                let authorizationEnter = document.createElement("button");
                authorizationEnter.textContent = "Войти";
                authorizationEnter.className = "authorization__send";

                // Входим в личный кабинет по смс.
                authorizationEnter.onclick = function enterListener(){
                    if (mySmsPassword == inputSms.value){

                        enter = true // Вход совершен.


                        // Удаление прошлых элемнтов.
                        while (document.querySelector('.main').firstChild) {
                            document.querySelector('.main').removeChild(document.querySelector('.main').firstChild);
                        }

                        // Замена заголовков страницы
                        if (document.getElementById("autorizationTitle") != null){
                            document.getElementById("autorizationTitle").remove();
                        }

                        // Если надпись еще не была добавлена.
                        if (document.getElementById("autorizationTitle") == null){
                            let new_title = document.createElement('p');
                            new_title.id = "autorizationTitle";
                            new_title.textContent = '/Личный кабинет';
                            new_title.className = "adder_title-page";
                            document.getElementById("myTitle").appendChild(new_title);
                        }
                        document.getElementById('myTypePage').textContent = "Личный кабинет";

                        // Заполнение личного кабинета.
                        section = document.createElement('section');
                        section.className = "authorization";
                        document.querySelector(".main").appendChild(section);

                        // Создаем форму данные об клиенте.
                        let infoClient = document.createElement("div");
                        infoClient.className = "info__client";
                        section.appendChild(infoClient);

                        // теперь заполним его полями.
                        let infoTitle = document.createElement("h2");
                        infoTitle.className = "info__title";
                        infoTitle.textContent = "Вы просто лучший клиент нашего магазина!";
                        infoClient.appendChild(infoTitle);

                        let infoLabel = document.createElement("div");
                        infoLabel.className = "info__label";
                        infoLabel.textContent = "Ваш адресс: Гринвич Виллидж 177А улица Бликер, Нью-Йорк, НЙ 10012-1406 (177A Bleecker Street, New York City, NY 10012-1406)";
                        infoClient.appendChild(infoLabel);

                        let infoEmail = document.createElement("a");
                        infoEmail.href="mailto:drstrange@mail.com"
                        infoEmail.className = "my-email";
                        infoEmail.textContent = "drstrange@mail.com";
                        infoEmail.style.color = "black";
                        infoClient.appendChild(infoEmail);


                    }
                }

            formReg.appendChild(inputSms);
            formReg.appendChild(authorizationEnter);
        } else {
            field_error.appendChild(spanError);
        }
    }
    formReg.appendChild(authorizationSend);

    } else{
        // Здесь по хорошему надо открывать личный кабинет, но...
    }

}


function div(val, by){
    return (val - val % by) / by;
}

function createItems(mySort = baseSort){
    products_load = [];

    // Вывод содержимого json на экран
    onLoad(mySort);
}

function onLoad(mySort){

    mySort.forEach(i => {
        let d = document.createElement('div');

        // Открытия доп. информации о товаре.
        d.onclick = function openProduct(){
            console.log(i);
            // Удаление прошлых элемнтов.
            if (document.querySelector('.products') != null){
                while (document.querySelector('.products').firstChild) {
                    document.querySelector('.products').removeChild(document.querySelector('.products').firstChild);
                }
            }

            let myProduct = document.createElement("div");
            myProduct.className = "my_product"

            // Добавляем картинки
            let imgBig = document.createElement('img');
            let imgBigWrap = document.createElement('div');
            imgBigWrap.className = "imgBigWrapper";
            imgBigWrap.appendChild(imgBig);
            imgBig.src = products.products[i].image;
            imgBig.className = 'imageBig';

            myProduct.appendChild(imgBigWrap);

            // добавляем Описание.
            let shortDescription = document.createElement('p');
            let price = document.createElement('p');
            let productInfo = document.createElement('div');
            let fullDescription = document.createElement('p');

            productInfo.className = "product_full_info";

            shortDescription.className = "short_description";
            shortDescription.textContent = products.products[i].short_description;
            productInfo.appendChild(shortDescription);

            // Цена.
            let myPrice = products.products[i].price;
            price.textContent = div(myPrice, 1000) + " " + myPrice % 1000;
            price.className = 'myPrice';
            productInfo.appendChild(price);

            fullDescription.className = "full_description";
            fullDescription.textContent = products.products[i].description;
            productInfo.appendChild(fullDescription);

            myProduct.appendChild(productInfo);

            document.querySelector(".products").appendChild(myProduct);
        }

        // Создаем элемент, добавляем ему стилей и т.д.
        d.className = "item";
        let img = document.createElement('img');
        let imgWrap = document.createElement('div');
        imgWrap.className = "imgWrapper";
        imgWrap.appendChild(img);
        img.src = products.products[i].image;
        img.className = 'image';

        d.appendChild(imgWrap);

        // Краткое описание.
        // let short_description = document.createElement('p');
        // short_description.className = "short_description";

        // short_description.textContent = products.products[i].short_description;

        let shortDescription = document.createElement('p');
        let price = document.createElement('p');
        let productInfo = document.createElement('div');

        productInfo.className = "product_info";

        shortDescription.className = "short_description";
        shortDescription.textContent = products.products[i].short_description;
        productInfo.appendChild(shortDescription);

        // Цена.
        let myPrice = products.products[i].price;
        price.textContent = div(myPrice, 1000) + " " + myPrice % 1000;
        price.className = 'price';
        productInfo.appendChild(price);

        d.appendChild(productInfo);

        products_load.push(d);
            // console.log(product.querySelector('.price').textContent);
        });


    // Вывод массива.
    for (i = 0; i < mySort.length; i++){
        document.querySelector('.products').appendChild(products_load[i]);
    }
}

// Сортировка продуктов по цене
function sortProducts(sortType="", keyProduct = ""){
    let map = new Map()
    products.products.forEach(el => {
        let condition = el.short_description.toUpperCase().indexOf(keyProduct.toUpperCase()) == -1 ? 0: 1;
        if (condition){
            map.set(el.id, el.price);
        }
    });
    const mapSortUpper = new Map([...map.entries()].sort((a, b) => a[1] - b[1]));
    const mapSortBelow = new Map([...map.entries()].sort((a, b) => a[1] - b[1]).reverse());

    // Удаление прошлых элемнтов.
    if (document.querySelector('.products') != null){
        while (document.querySelector('.products').firstChild) {
            document.querySelector('.products').removeChild(document.querySelector('.products').firstChild);
        }
    }

    if (sortType == "upper"){
        createItems(Array.from(mapSortUpper.keys()));
    } else if (sortType == "below"){
        createItems(Array.from(mapSortBelow.keys()));
    } else if(Array.from(map.keys()).length == 0){
        let message = document.createElement('p');
        message.className = "short_description";
        message.textContent = "Нет товаров, подходящих под описание.";
        message.style.color = "red";
        message.style.background = "white";

        document.querySelector('.products').appendChild(message);
    } else {
        createItems(Array.from(map.keys()));
    }
}

// -------------------------------------------------------Загружаем данные------------------------------------------
//Функция забора информации из URL
window.onload = function getInfoFromUrl(){
    let url = new URL(window.location.href);
    let nameProducts = "";

    if (url.searchParams.get("search") == null){
        nameProducts = "";
    } else{
        nameProducts = url.searchParams.get("search");
    }

    if (url.searchParams.get("dzen") == null)
        sortType = "";
    else
        sortType = url.searchParams.get("dzen");

    // console.log("sortType=", sortType);
    sortProducts(sortType, nameProducts);
    }

    if (document.getElementById("autorizationTitle") != null){
        document.getElementById("autorizationTitle").remove();
    }
    document.getElementById('myTypePage').textContent = "Каталог товаров"
    let newTitle = document.createElement('p');
    newTitle.id = "catalogTitle";
    newTitle.textContent = '/Каталог';
    newTitle.className = "adder_title-page";
    document.getElementById("myTitle").appendChild(newTitle);